---
name: qa-sentinel:setup
description: Initialize Sentinel QA testing with Playwright Test Agents integration
argument-hint: "[optional: base URL of the application]"
---

# Initialize Sentinel QA Testing

Set up NL spec-driven QA testing in the current project using Playwright Test Agents.

## User Input

```text
$ARGUMENTS
```

## Input Interpretation

| Input Pattern | Interpretation |
|---------------|----------------|
| Empty | Prompt for base URL during config generation |
| `http://localhost:3000` | Use as the application base URL |
| `https://staging.example.com` | Use as the application base URL |

## Phase 1: Check Prerequisites

### Verify Node.js

```bash
node --version
```

If Node.js is not installed, stop and tell the user: "Node.js is required for Sentinel. Install it from https://nodejs.org and try again."

### Verify `@playwright/test` ≥1.56

```bash
npx playwright --version
```

If not installed or version is below 1.56, tell the user: "Install @playwright/test ≥1.56: `npm install -D @playwright/test`" and stop.

## Phase 2: Scaffold Directory Structure

Create the required directories:

```bash
mkdir -p specs
mkdir -p tests
```

The directory layout is:

```
specs/         <- NL spec files (authored by you, versioned)
tests/         <- generated .spec.ts files (generated by Playwright Planner/Generator)
```

## Phase 3: Generate Configuration

Use `AskUserQuestion` to gather configuration values interactively. If `$ARGUMENTS` contains a URL, use it as the default for the base URL question.

### 3a. Application Details

Ask the user:

1. **Base URL** — "What is the base URL of your running application?" (default: value from `$ARGUMENTS` or `http://localhost:3000`)
2. **Application name** — "What is the human-readable name for this application?" (default: derive from the project directory name)

### 3b. Authentication Strategy

Ask the user:

"How does authentication work in your application?"
- **credentials** — Login form with username/password
- **token** — Bearer token set via header or cookie
- **cookie** — Pre-set session cookie
- **none** — No authentication required

### 3c. Credentials Details (if strategy is `credentials`)

If the user chose `credentials`, ask:

1. **Login URL** — "What is the login page path?" (default: `/login`)
2. **Username** — "What username/email should be used for QA testing?" (e.g., `qa-tester@example.com`)
3. **Password env var** — "What environment variable holds the QA password?" (default: `SENTINEL_QA_PASSWORD`). Remind the user: "Never put actual passwords in config files. Set this env var in your shell before running tests."

### 3d. Browser Preferences

Ask the user:

1. **Headless mode** — "Run the browser in headless mode?" (default: `true`)
2. **Viewport size** — "What viewport size?" (default: `1280x720`)

### 3e. Bridge Configuration (optional)

If the application uses an HTTP bridge (e.g., Tauri apps tested via bridge shim), ask:

1. **Bridge shim path** — "Path to the bridge injection script?" (e.g., `apps/http-bridge/bridge-inject.js`)
2. **Bridge port** — "What port does the HTTP bridge run on?" (default: `9990`)
3. **Partitioned execution** — "Do you use multiple bridge instances for parallel testing?"

If partitioned, ask for partition configuration:
- **Partition names and ports** — Map area names to bridge ports (e.g., `workspace-pages: 9990, editor-content: 9991`)

### 3f. Write the Config File

Write `sentinel.config.yaml` using the gathered values:

```yaml
# ── Sentinel Configuration ───────────────────────────────────────────
# Generated by qa-sentinel:setup
# ──────────────────────────────────────────────────────────────────────

app:
  base_url: {base_url}
  name: {app_name}

auth:
  strategy: {strategy}
  # Include login_url and credentials block only if strategy is "credentials"
  # Include token/cookie guidance comments for other strategies

browser:
  headless: {headless}
  viewport:
    width: {width}
    height: {height}
  timeout: 30000

# Bridge configuration (for Tauri apps tested via HTTP bridge)
bridge:
  # shim_path: {shim_path}
  # port: {bridge_port}
  # partitions:
  #   {area-name}: {port}

# Playwright configuration
playwright:
  config_path: ./playwright.config.ts

# Spec and test directories
specs:
  nl_dir: ./specs
  tests_dir: ./tests
```

If bridge config was gathered in step 3e, uncomment and populate the `bridge` section. Example:

```yaml
bridge:
  shim_path: apps/http-bridge/bridge-inject.js
  port: 9990
  partitions:
    workspace-pages: 9990
    editor-content: 9991
    navigation-search: 9992
    advanced-features: 9993
```

For the `auth` section, adapt based on the chosen strategy:

**credentials:**
```yaml
auth:
  strategy: credentials
  login_url: {login_url}
  credentials:
    username: {username}
    password_env: {password_env}
```

**token:**
```yaml
auth:
  strategy: token
  # Set the SENTINEL_AUTH_TOKEN env var before running tests
  # Sentinel will include this as a Bearer token in browser requests
```

**cookie:**
```yaml
auth:
  strategy: cookie
  # Set the SENTINEL_SESSION_COOKIE env var before running tests
  # Sentinel will set this cookie in the browser before navigating
```

**none:**
```yaml
auth:
  strategy: none
```

## Phase 4: Playwright Init Agents

Run Playwright Test Agents init to set up the agent scaffolding:

```bash
npx playwright init-agents --loop=claude
```

If this command is not available (older Playwright version or command not recognized), manually scaffold the agent config:

1. Inform the user: "Playwright init-agents not available. Scaffolding manually."
2. Proceed to Phase 5 to generate `playwright.config.ts` and `tests/seed.spec.ts` directly.

## Phase 5: Generate `playwright.config.ts`

Write `playwright.config.ts` in the project root with bridge shim support and reporter configuration:

```typescript
import { defineConfig, devices } from '@playwright/test';
import * as fs from 'fs';

// Bridge shim injection (for Tauri apps tested via HTTP bridge)
// Set SENTINEL_BRIDGE_SHIM to the path of the bridge inject script
const bridgeShimPath = process.env.SENTINEL_BRIDGE_SHIM;
const bridgeShim = bridgeShimPath && fs.existsSync(bridgeShimPath)
  ? fs.readFileSync(bridgeShimPath, 'utf-8')
  : undefined;

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['list'],
  ],
  use: {
    baseURL: process.env.SENTINEL_BASE_URL || '{base_url}',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    ...(bridgeShim ? { initScripts: [bridgeShim] } : {}),
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
```

If partitioned bridge execution was configured, add project entries per partition:

```typescript
projects: [
  {
    name: 'workspace-pages',
    use: {
      ...devices['Desktop Chrome'],
      baseURL: 'http://localhost:9990',
    },
    testMatch: '**/workspace-*.spec.ts',
  },
  {
    name: 'editor-content',
    use: {
      ...devices['Desktop Chrome'],
      baseURL: 'http://localhost:9991',
    },
    testMatch: '**/editor-*.spec.ts',
  },
],
```

## Phase 6: Create `tests/seed.spec.ts`

Write `tests/seed.spec.ts` — a seed spec with project-specific fixtures for auth setup and base URL configuration:

```typescript
import { test as base, expect, Page } from '@playwright/test';

// Extend base test with project-specific fixtures
export const test = base.extend<{
  authenticatedPage: Page;
}>({
  authenticatedPage: async ({ page }, use) => {
    // Auth setup — adapt to your auth strategy
    // strategy: none — no setup needed
    // strategy: credentials — navigate to login and fill credentials
    // strategy: token — set Authorization header
    // strategy: cookie — set session cookie

    // Example for 'none' strategy:
    await page.goto('/');
    await use(page);
  },
});

export { expect };

// Seed test — verifies the test setup is working
test('app loads successfully', async ({ page }) => {
  await page.goto('/');
  await expect(page).toHaveTitle(/.+/);
});
```

If the auth strategy is `credentials`, generate a fixture that navigates to the login URL and fills credentials from environment variables.

## Phase 7: Write .gitignore

Write `.gitignore` additions (or create `tests/.gitignore`):

```
# Playwright artifacts
test-results/
playwright-report/
blob-report/

# Keep NL specs and generated tests in version control
```

## Phase 8: Update Project CLAUDE.md

Read the project's `CLAUDE.md` file (in the project root). If it exists, append a Sentinel section. If it does not exist, create it with the Sentinel section.

Append the following section (do not duplicate if it already exists):

```markdown
## QA Testing (Sentinel)

This project uses Sentinel for NL spec-driven QA testing with Playwright Test Agents.

- **NL Specs**: `specs/` — natural language spec files that describe feature behavior
- **Generated Tests**: `tests/` — `.spec.ts` files generated by Playwright Planner/Generator
- **Config**: `sentinel.config.yaml`

### Commands

- `/qa-sentinel:setup` — Initialize Sentinel (already done)
- `/qa-sentinel:discover` — Scan app and author NL specs
- `/qa-sentinel:audit` — Detect drift between NL specs, generated tests, and app behavior

### Running Tests

```bash
npx playwright test              # Run all tests
npx playwright test --headed     # Run with visible browser
npx playwright show-report       # View HTML report
```
```

## Phase 9: Completion

Display a summary:

```markdown
## Sentinel Setup Complete

**Config**: sentinel.config.yaml
**NL Specs directory**: specs/
**Generated Tests directory**: tests/
**Base URL**: {base_url}
**Auth**: {strategy}

### Directory Structure

specs/          <- NL spec files (author here)
tests/          <- generated .spec.ts files
  seed.spec.ts  <- fixture setup
playwright.config.ts
sentinel.config.yaml
.gitignore

### What's Next?

1. **Discover features** — Run `/qa-sentinel:discover` to create NL specs
2. **Generate tests** — Use Playwright Planner/Generator to convert NL specs to .spec.ts
3. **Run tests** — `npx playwright test` to execute generated tests
4. **Audit drift** — Run `/qa-sentinel:audit` to check spec-test-app alignment
```

Ask the user: "Would you like to run `/qa-sentinel:discover` now to scan your application and generate initial NL specs?"
